---
title: "Run Your Own AI Weather Model"
collection: notes
type: "misc."
permalink: /teaching/ai-weather-models
venue: "misc."
date: 2025-09-11
location: "Cambridge, MA"
---

This is a quick intro on how to use run the (Nvidia) fourcastnetv2 and (Huawei) pangu AI model from ecmwf-plugin [instructions](https://github.com/ecmwf-lab/ai-models-fourcastnetv2).

Update 2025-Sep-11: Also added fourcastnet0.1 from ECMWF and (Microsoft) [Aurora](https://microsoft.github.io/aurora/usage.html). (Google) GraphCast is still not working well due to compatibility issues with [JAX](https://docs.jax.dev/en/latest/notebooks/thinking_in_jax.html).

Partial results are used in my final project for MIT Course 12.810 Atm. Dynm. (2025 Spring, taught by [Paul O'Gorman](https://pog.mit.edu/)) titled:

# Are AI Weather Forecasts Respecting Atmosphere Dynamics?

[Presentation slides](https://docs.google.com/presentation/d/1Fc3dxT8FHEhQyJtkR-TnMw4C7LkZFhQc/edit?usp=sharing&ouid=116465514317596629476&rtpof=true&sd=true) and [write-ups](https://www.overleaf.com/read/tmbnxtbjfrqf#b6c379) are available.

Cover photo generated by ChatGPT-4o

![image](https://github.com/user-attachments/assets/6ca37965-dedf-47ca-af7b-a71bd11cb7ba)


**As of April 10th, 2025**

For non-commerical usage of ECMWF open accounts, the service/MARS will not be available, which means the **most recent 30 day reanalysis will NOT be available**, and the configuration of "/.ecmwfapirc" file would thus lead to errors of not being authorized. Issues have been encountered in [post](https://github.com/google/weather-tools/issues/35) and [issue](https://github.com/ecmwf-lab/ai-models-fourcastnetv2/issues/1)...

Instead, the solution is to use *copernicus CDS* open access data, which requires a "/.cdsapirc" file that you can find api instructions [here](https://cds.climate.copernicus.eu/how-to-api).

---

# Tutorials on running your own 5-day, 6-hourly **AI weather forecast**! (on MIT Engaging)

## Allocate node and Modules + Conda Env

```bash
salloc -N1 -c2 --mem=4G -t 6:00:00 -p mit_normal_gpu --gres=gpu:1
```

Make sure you see both `cuda/12.4.0` and `cudnn/9.8.0.87-cuda12` available (via `module avail`).
<img width="3762" height="756" alt="image" src="https://github.com/user-attachments/assets/0f04e930-b937-45f3-81a4-36ea07b962e8" />


```bash
module purge
module load StdEnv gcc/12.2.0 miniforge/24.3.0-0 cuda/12.4.0 cudnn/9.8.0.87-cuda12
```

```bash
conda create -n ai-ml12 python=3.10 -y
conda activate ai-ml12
```

### (IMPORTANT) add the correct cuDNN lib dir
```bash
export LD_LIBRARY_PATH="$CUDNN_HOME/lib:$LD_LIBRARY_PATH"
```

### (Optional) keep pip inside env (not ~/.local)

```bash
export PYTHONNOUSERSITE=1
```

## Installations

```bash
pip install ai-models
pip install ai-models-panguweather
pip install ai-models-fourcastnet
```

~~`pip install ai-models-graphcast  # Install from https://github.com/ecmwf-lab/ai-models-graphcast`~~


```bash
pip install ai-models-fourcastnetv2
pip install ai-models-aurora
pip install --extra-index-url https://download.pytorch.org/whl/cu124 torch torchvision torchaudio
pip install tensorflow
# Necessary for Pangu GPU
pip install onnxruntime-gpu --upgrade
```

~~`pip install "jax[cpu]" dm-haiku`~~

Now you should have CUDA 12.4, cuDNN 9.8, ONNX Runtime 1.22.
<img width="1050" height="699" alt="image" src="https://github.com/user-attachments/assets/e52fad1f-e3f0-469f-909d-999e6bc89819" />
<img width="588" height="72" alt="image" src="https://github.com/user-attachments/assets/aaf68962-f3d4-48dd-abb4-2012b10c1547" />
<img width="1149" height="243" alt="image" src="https://github.com/user-attachments/assets/9d78ab63-068f-4202-b719-039bcb0c6103" />



## Correct MARS to CDS

### replace the source "mars" -> "cds" for all load helpers - if installed in conda site-packages not ./local, change dir accordingly

```bash
cp -a ~/.local/lib/python3.10/site-packages/ai_models/inputs/mars.py       ~/.local/lib/python3.10/site-packages/ai_models/inputs/mars.py.bak

sed -i 's/from_source("mars"/from_source("cds"/g'   ~/.local/lib/python3.10/site-packages/ai_models/inputs/mars.py
```


## Download assets for (auto-download has bugs for Aurora)
```bash
mkdir -p /orcd/pool/006/x_yan/ai_model_assets/fourcastnet0.1
mkdir -p /orcd/pool/006/x_yan/ai_model_assets/fourcastnetv2-small
mkdir -p /orcd/pool/006/x_yan/ai_model_assets/graphcast
mkdir -p /orcd/pool/006/x_yan/ai_model_assets/panguweather
mkdir -p /orcd/pool/006/x_yan/ai_model_assets/aurora
```


```bash
wget -O /orcd/pool/006/x_yan/ai_model_assets/aurora/aurora-0.1-static.pickle   https://huggingface.co/microsoft/aurora/resolve/main/aurora-0.1-static.pickle
```

It is **NORMAL** to see messages about MARS when not specifying CDS.
<img width="1134" height="120" alt="image" src="https://github.com/user-attachments/assets/b20191bf-27bc-4011-b159-4c33ef1bcc26" />


## Run Predictions!
Documentation:

```bash
ai-models --help
```


### Sample Prediction starting at 2023-Jan-10th 00UTC 

fourcastnetv2-small
```bash
ai-models   --download-assets   --assets /orcd/pool/006/x_yan/ai_model_assets   --assets-sub-directory   --input cds   --date 20230110 --time 0000 --lead-time 120   --output file   --path /orcd/pool/006/x_yan/ai_model_assets/fourcastnetv2-small/fc_20230110T0000_+120h.grib   fourcastnetv2-small
```

Pangu
```bash
ai-models   --download-assets   --assets /orcd/pool/006/x_yan/ai_model_assets   --assets-sub-directory   --input cds   --date 20230110 --time 0000 --lead-time 120   --output file   --path /orcd/pool/006/x_yan/ai_model_assets/panguweather/fc_20230110T0000_+120h.grib   panguweather
```

fourcastnet
```bash
ai-models   --download-assets   --assets /orcd/pool/006/x_yan/ai_model_assets   --assets-sub-directory   --input cds   --date 20230110 --time 0000 --lead-time 120   --output file   --path /orcd/pool/006/x_yan/ai_model_assets/fourcastnet0.1/fc_20230110T0000_+120h.grib   fourcastnet
```

Aurora
```bash
ai-models   --assets /orcd/pool/006/x_yan/ai_model_assets   --assets-sub-directory   --input cds   --date 20230110 --time 0000 --lead-time 120   --output file   --path /orcd/pool/006/x_yan/ai_model_assets/aurora/fc_20230110T0000_+120h.grib   aurora
```

### Customizable input
```bash
ai-models --file <some-grib-file> <model-name>
```


## Results
### Pangu (0.25 Resolution)
<img width="1152" height="714" alt="image" src="https://github.com/user-attachments/assets/bb6da627-5e02-4d51-aaca-e45b5bad0841" />
<img width="957" height="768" alt="image" src="https://github.com/user-attachments/assets/6c56036b-a81f-495c-bb0e-56991b71e122" />

### FourCastNetv2 (0.25 Resolution)
<img width="1143" height="609" alt="image" src="https://github.com/user-attachments/assets/823676e5-28d6-4e0f-99ff-633e8d741d6c" />
<img width="933" height="738" alt="image" src="https://github.com/user-attachments/assets/8b5f1fb7-7910-4a7a-9935-451751c21c54" />


### FourCastNet (0.25 Resolution)
<img width="1146" height="786" alt="image" src="https://github.com/user-attachments/assets/97436c92-a690-4529-98c5-51cf352468aa" />
<img width="918" height="762" alt="image" src="https://github.com/user-attachments/assets/961b3d75-dd55-4742-911b-81dfe06c3994" />


### Aurora (0.1 Resolution)
<img width="1179" height="756" alt="image" src="https://github.com/user-attachments/assets/855476d2-3a49-418c-a33a-59bf55344365" />
<img width="969" height="776" alt="image" src="https://github.com/user-attachments/assets/5598a479-0d36-4e22-97db-520c135cca86" />




---

### If you don't want to redownload assets for each time, simply delete --download-assets command
### If you want to download assets first without making predictions, simply do:
#### format: ai-models --download-assets --assets <some-directory> <model-name>

```bash
ai-models --download-assets --assets /orcd/pool/006/x_yan/ai_model_assets/panguweather/ panguweather

ai-models --download-assets --assets /orcd/pool/006/x_yan/ai_model_assets/fourcastnet0.1/ fourcastnet

ai-models --download-assets --assets /orcd/pool/006/x_yan/ai_model_assets/graphcast/ graphcast

ai-models --download-assets --assets /orcd/pool/006/x_yan/ai_model_assets/fourcastnetv2-small/ fourcastnetv2-small
```

---
# Run AI Forecast Ensembles (Fourcastnet v2)
Following Nvidia's [tutorial](https://catalog.ngc.nvidia.com/orgs/nvidia/teams/modulus/models/modulus_fcnv2_sm?version=v0.2)
```bash
module purge
module load StdEnv gcc/12.2.0 miniforge/24.3.0-0 cuda/12.4.0 cudnn/9.8.0.87-cuda12

export LD_LIBRARY_PATH="$CUDNN_HOME/lib:$LD_LIBRARY_PATH"

conda create --name earth2mip python=3.10
conda activate earth2mip

git clone https://github.com/NVIDIA/earth2mip.git
cd earth2mip

pip install .

pip install ipykernel
python -m ipykernel install --user --name=earth2mip-kernel

```




---
# Tutorials on running your own 10-day, 6-hourly **AI weather forecast**! (on MIT Dolma)

---

## Single Model: FourCastNetv2-small

### HPC setup and conda env demonstration for MIT Dolma Cluster
1. Read ECMWF [ai-models documentation](https://github.com/ecmwf-lab/ai-models)
2. module load apps/miniconda/3.6
3. conda create -n fourcastnetv2 -c conda-forge python=3.10 -y
4. source activate fourcastnetv2
5. pip install ai-models ai-models-fourcastnetv2
6. Dir of model weights and climatology files will be made automactially to: /home/x_yan/fourcastnetv2-small
7. Config api - two options: (a. Commercial or ECMWF authorized MARS access), or (b. Open research CDS access)
8. (Option a. MARS) Follow [link](https://confluence.ecmwf.int/display/WEBAPI/Access+MARS) to get MARS access
9. Make file .ecmwfapirc, add {"url"   : "https://api.ecmwf.int/v1", \n "key"   : "xxxxxxxxxxxxxxxxxxx", \n "email" : "xxxxxxxxx"}
10. (Option b. CDS) Follow [link](https://cds.climate.copernicus.eu/how-to-api) to get CDS access
11. Make file .cdsapirc, url: https://cds.climate.copernicus.eu/api \n key: xxxx-xxxx-xxxx-xxxx
12. Download data by running: ai-models --download-assets fourcastnetv2-small
11. Files of weights.tar, global_means.npy, and global_stds.npy should be seen in path /home/x_yan/fourcastnetv2-small/
12. (fourcastnetv2) x_yan@dolma:~$ cd fourcastnetv2-small/
13. When using CDS option, modify when using PyTorch > 2.6: (i)cd to your model.py path: cd /home/x_yan/.conda/envs/fourcastnetv2/lib/python3.10/site-packages/ai_models_fourcastnetv2/, (ii) open model.py, (iii) change line 146 checkpoint = torch.load(checkpoint_file, map_location=self.device) into checkpoint = torch.load(checkpoint_file, map_location=self.device, weights_only=False)
14. (fourcastnetv2) x_yan@dolma:~/fourcastnetv2-small$ ai-models --input cds --date 20230110 --time 0000 fourcastnetv2-small
15. (*Optional*) Other params - notice lead-time has unit of 1 hour - could be --date 2023-10-01 \ --time 00:00 \ --lead-time 24h \ --path /net/flood/data/users/x_yan/fourcastnetv2 \ --assets-sub-directory \ --input cds \ --output file
16. Output forecast file would be in the same folder named fourcastnetv2-small.grib
17. Enjoy! ![image](https://github.com/user-attachments/assets/05f03439-124c-404b-9741-80e426c7edc7)

### Interpret Results
1. Load the jupyter notebook from [link](https://colab.research.google.com/drive/1ieWTYO1lcaMRNH4CulRoQWXlF3o5gdAM?usp=sharing).
2. The forecast grib file is divided into surface and pressure-level data
3. Sample intial, 5day, and 10 day data visualizes as![image](https://github.com/user-attachments/assets/2e535fb1-8137-4d5f-b724-8374744286e5)![image](https://github.com/user-attachments/assets/4deea4d4-3cbe-44d4-89c4-6c7f6977ed21)![image](https://github.com/user-attachments/assets/15a31807-d9c5-42b2-a798-3b508d519060)![image](https://github.com/user-attachments/assets/e70b305b-fe09-4510-b04f-17265fa7dab4)![image](https://github.com/user-attachments/assets/ee09b66e-d203-4161-9972-1d5c4d504c7c)![image](https://github.com/user-attachments/assets/64444222-136a-4d7e-8884-76c9d623f013)



--- 
## Multiple Models: FourCastNetv2-small & Panguweather
1. module load apps/miniconda/3.6
2. conda create -n ai-weather -c conda-forge python=3.10 -y
3. source activate ai-weather
4. Check your available nvaa cuda version by: conda search -c nvidia cudatoolkit
5. conda install -c "nvidia/label/cuda-11.7.0" \    cudatoolkit=11.7.0 \     cudnn=8.9.5
6. pip install onnxruntime-gpu==1.17.1
7. conda install -c "nvidia/label/cuda-11.7.0" cuda-nvcc
8. Check nvcc --version
9. pip install     ai-models     ai-models-fourcastnetv2     ai-models-panguweather
10. ai-models --download-assets --assets <some-directory> <model-name>
11. Modify the model.py as above section
12. cd to dir to run models (Example: cd /home/x_yan/ai_weather_models/fourcastnetv2-small, or cd /home/x_yan/ai_weather_models/panguweather)
13. ai-models --input cds --date 20250110 --time 0000 --lead-time 48 panguweather
14. **As of April 11, 2025**, the panguweather could only be run on CPU due to ONNX issues, such that each step takes around 4 minutes to run on a CPU, rather than seconds on a GPU; see details [here](https://github.com/ecmwf-lab/ai-models). The solution of conda env with cuda-toolkit is not helpful. ![image](https://github.com/user-attachments/assets/b89e54b5-2407-4374-8f48-aa3c01b7a462)

### Below is a 48-lead time, 6-hourly forecast comparison btwn Pangu (upper row) vs. FourCastNetv2 (lower row), evaluated at init. (same), 24 hr, & 48 hr 
1. Geopotential Height z500 ![image](https://github.com/user-attachments/assets/e56231e5-45e2-498f-b383-ddfcdb2e3b68) ![image](https://github.com/user-attachments/assets/ce4bb831-3851-4067-a5a9-0144db84e9ed)
2. Temperature T500 ![image](https://github.com/user-attachments/assets/7fa2b40e-36a4-4be4-bab6-2f7153591ef1) ![image](https://github.com/user-attachments/assets/6b38c8f6-2ede-4536-8182-5091ba256c83)
3. Zonal wind u500 ![image](https://github.com/user-attachments/assets/6abd8cf6-1694-4b06-b749-a0bf1f992796) ![image](https://github.com/user-attachments/assets/7ffb22ce-cef0-434c-b309-5ea146ffbe3c)
4. Merdional wind v500 ![image](https://github.com/user-attachments/assets/d6d87906-ddbb-40f1-bc28-ee2a5e6b6bdc) ![image](https://github.com/user-attachments/assets/9df6bc5f-f777-4265-99fb-28319b999165)

---

## Latest Fix for CUDA 12.2 - use MIT Engaging instead (no good)!
#### 1. Load Miniconda module (HPC-specific)
module load miniforge/24.3.0-0

#### 2. Create Conda environment
conda create -n ai-weather -c conda-forge python=3.10 -y

#### 3. Activate environment
conda activate ai-weather 

#### 4. Install CUDA 12.1 toolkit + cuDNN 9.1.1.17 (confirmed available via conda search -c nvidia cudnn)
conda install -c nvidia/label/cuda-12.6 cuda-toolkit=12.6 -y

conda install -c nvidia cudnn=9.3.0.75=cuda12.6* -y

#### 5. Install ONNX Runtime with GPU support
pip install \
  https://huggingface.co/onnxruntime/onnxruntime/releases/download/v1.17.1/onnxruntime_gpu-1.17.1-cp310-cp310-linux_x86_64.whl

#### 6. Install ECMWF AI model packages
pip install cdsapi ai-models ai-models-fourcastnetv2 ai-models-panguweather 

#### 7. Download model weights & statistics
ai-models --download-assets --assets /home/x_yan/12.810/ai_models fourcastnetv2-small

ai-models --download-assets --assets /home/x_yan/12.810/ai_models panguweather

modify: /home/x_yan/.local/lib/python3.10/site-packages/ai_models_fourcastnetv2/model.py

#### 8. Verifiation
python -c "import onnxruntime as ort; print('ONNX device:', ort.get_device())"

nvcc --version

#### 9. Request GPU
salloc -N 1 -c 32 --mem=64G --gres=gpu:1 -t 12:00:00 -p mit_preemptable

#### 10. cd to model path
cd /home/x_yan/12.810/ai_models

#### 11. Run job sample
ai-models \
  --input cds \
  --date 20241005 \
  --time 0000 \
  --lead-time 144 \
  --output file \
  --path /home/x_yan/12.810/ai_models/results/000_20241005_panguweather.grib \
  panguweather

#### 12. Run batch sample
conda activate ai-weather
salloc -N 1 -c 32 --mem=64G --gres=gpu:1 -t 12:00:00 -p mit_preemptable
load the .sh file [here](https://colab.research.google.com/drive/12V4xD5B2SCpMtfbUe_NShnMEkyKka5sH?usp=sharing)
chmod +x run_forecasts.sh
./run_forecasts.sh
you should see 
![image](https://github.com/user-attachments/assets/b19dc2cf-332c-4348-9e10-63c4e4c6aa22)


#### Supp: Register the environment as a kernel
pip install ipykernel
python -m ipykernel install --user --name=ai-weather



















